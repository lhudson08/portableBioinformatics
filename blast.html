<html>
  <meta charset="UTF-8">
  <head>
    <title>htmlBio BLAST</title>
    <link rel="stylesheet" type="text/css" href="css/reset.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <script src="lib/prototype1.7.2"></script>
    <script src="lib/bio-js-LK/Bio.js"></script>
    <!-- TODO add SW to Bio::JS -->
    <script src="src/smithWaterman.js"></script>
    <!--
    <script src="lib/NtSeq/lib/nt.js"></script>
    <script src="lib/jquery-2.1.4.min.js"></script>
    <script src="lib/bio-js-LK/src/Bio.js"></script>
    -->
    <script>
	
	document.observe("dom:loaded",function(){
      /*
      // Listen to the seqFile inputs, to load sequences
      $$(".seqFile").each.observe("change",function(event){
	    var querySeq=loadSeq(event);
	    event.preventDefault();
	  });
	  */
	  $("runANI").observe("click",function(event){
	    runANI(event);
	    event.stop();
	  });
	  

	  var SW=new SmithWaterman("ACACACTA","TAGCACACA");
	  var [score,swPath]=SW.run();
	  
	  amReady();
	});
    function loadSeq(event){
	  amBusy();
	  var targetEl=event.currentTarget
	  var filename=targetEl.value
	  var file=targetEl.files[0]
	  
	  containerElId=targetEl.id+"_container";
	  containerEl=$("#"+containerElId);
	  
	  var fr=new FileReader();
	  fr.onload=function(e){
	    var fileContent=escape(e.target.result)
        console.log("Setting "+containerElId+" to the file content");
        containerEl.html(fileContent);
        console.log(fileContent.substr(0,60) + "...");
        amReady();
      }
      fr.readAsText(file)
	}
	
	function runANI(event){
	  amBusy();
	  var query=unescape($("#QUERY_container").html());
	  var subject=unescape($("#SUBJECT_container").html());
	  
	  // split the query into 1024 nt chunks
	  
	  // run smith-waterman vs the subject
	  
	  amReady();
	}
	
	var busyCounter=1; // 0 when not busy; document.ready will decrease this to 0
	function amReady(decrement=1){
	  busyCounter-=decrement;
	  $("ready").update(busyCounter);
	  if(busyCounter<1){
	    $("ready").setStyle({'background-color':"#77FF77"});
	  }
	}
	function amBusy(increment=1){
	  busyCounter+=increment;
	  $("ready").update(busyCounter);
	  if(busyCounter >=1 ){
	    $("ready").setStyle({'background-color':"#FF7777"});
	  }
	}
    </script>
  </head>  
  <body>
    <div>
      <span id="ready" style="height:20px;width:20px;padding:5">&nbsp;</span>
      <p>
	    <input type="file" class="seqFile" name="QUERY" id="QUERY" />
        <div class="hidden" id="QUERY_container"></div>
        <br />
	    <input type="file" class="seqFile" name="SUBJECT" id="SUBJECT" />
        <div class="hidden" id="SUBJECT_container"></div>
      </p>
      
      <p><input type="submit" id="runANI" /></p>
    </div>
  </body>
 
</html>
